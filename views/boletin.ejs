<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width initial-scale=1">
	<meta name="viewport" content="width=device-width" />
     <title><%= noticias.length > 0 ? noticias[0].titulo : 'Boletín' %></title>
    <style>
        #templateContainer {
            width: 650px;
            font-family: 'Helvetica Neue', Arial, Helvetica, 'sans-serif';
        }

        @media only screen and (max-width: 550px) {
            table[id=templateContainer] {
                width: 100% !important;
            }

            table[class=columns] {
                width: 100% !important;
            }
        }
        @media screen and (max-width: 600px) {
            li {
            text-align: left;
        }
        img {
            display: block;
            margin: 0 auto;
        }
       table {
           width:100%;
       }
       td.coml1 {
        width: 35px!important;
        height: 0px;
    }
       
}
    </style>
</head>
<body leftmargin="0" topmargin="0" bgcolor="#fafafa" marginwidth="0" marginheight="0">


    </div>
    
    <table id="templateContainer" cellspacing="0" style="background-color: #d0f3fb;border-radius: 7px; margin-top:20px; margin-bottom: 20px;box-shadow: 0px 0px 5px #00000020;"
    cellpadding="0" align="center" width="600px" border="0">
        <tr>
            <td align="center" style="background-color: #36BFDF;">
                <p style="height: 0px;">&nbsp;</p>
            </td>
        </tr>

        <tr>
            <td align="center" style="background-color: rgb(255, 255, 255);color: #000; margin: 0; font-weight: bold;">
                <p style="color: #000;">BOLETÍN</p>
            </td>
        </tr>

        <tr>
            <td align="center" style="background-color: #36BFDF;">
                <a href="https://www.eleconomista.com.mx/el-empresario">
                    <img src="https://media.eleconomista.com.mx//contenido/depurador/images/empresario/logo1.png" style="width: 50%; padding-bottom: 0px; padding-top: 20px;" alt="El Empresario">
                </a>
                <p id="fecha-del-boletin" style="padding: 10px; margin: 0;">Cargando fecha...</p>
            </td>
        </tr>

        <tr>
            <td align="center" style="background-color: #d0f3fb;">
                <% if (noticias[0] && noticias[0].imagen && noticias[0].link) { %> <!-- Verifica que noticias[0], imagen y link existan -->
                    <a href="<%= noticias[0].link %>" target="_blank">
                        <img src="<%= noticias[0].imagen %>" style="width: 90%; padding-bottom: 20px; padding-top: 20px;" />
                    </a>
                <% } else if (noticias[0] && noticias[0].imagen) { %> <!-- Si solo hay imagen sin enlace -->
                    <img src="<%= noticias[0].imagen %>" style="width: 90%; padding-bottom: 20px; padding-top: 20px;" />
                <% } %> <!-- Si no hay ni imagen ni enlace, no se renderiza nada -->
            </td>
        </tr>
        
        <tr>
            <td style="padding-left: 5%; padding-right: 0%; padding-top: 0px;">
                <p style="font-weight: 600; color: #000000; font-size: 2.5em; margin: 0; line-height: 40px;">
                    <% if (noticias[0] && noticias[0].link) { %> <!-- Solo mostrar el título si hay un enlace -->
                        <a href="<%= noticias[0].link %>" target="_blank" style="font-family: Georgia, 'Times New Roman', Times, serif; font-size: 30px; line-height: 36px; color: #000000; text-decoration: none;">
                            <%= noticias[0].titulo %>
                        </a>
                    <% } else if (noticias[0] && noticias[0].titulo) { %> <!-- Si no hay enlace, solo mostrar el título -->
                        <%= noticias[0].titulo %>
                    <% } %> <!-- Si no hay título ni enlace, no se muestra nada -->
                </p>
            </td>
        </tr>
        
        <tr>
            <td style="padding-left: 5%; padding-right: 0%; padding-top: 0px;">
                <p style="color: #000000;"></p>
                <p>
                    <%= noticias[0] && noticias[0].resumen ? noticias[0].resumen.replace(/\n/g, '<br>') : 'Agrega las URLs' %> <!-- Si no hay resumen, muestra un mensaje por defecto -->
                </p>
            </td>
        </tr>
        
        <tr>
            <td align="center">
                <p style="height: 0px; text-align: left; border-top: 1px solid #37c0df; width: 90%; padding: 0; margin: 0;">&nbsp;</p>
            </td>
        </tr>
        
        <!-- Fila de "PYMES" abarcando 3 columnas -->
        <tr>
            <td colspan="3" style="padding-left: 5%; padding-right: 0%; padding-top: 0px;">
                <p style="margin: 0;font-weight: 700; color: #36c0df; background: #000; padding: 10px; width: 15%; text-align: center;">
                    <a href="https://eleconomista.com.mx/el-empresario/pymes" style="color: #36c0df; text-decoration: none;" target="_blank" zcurl_name="l_3">PYMES</a>
                </p>
            </td>
        </tr>
        
        <% noticias.slice(1).forEach(function(noticia, index) { %>
            <tr>
                <td style="padding-left: 5%; padding-right: 0%; padding-top: 0px;">
                    <p style="padding-top: 20px; font-weight: 600; color: #000000; font-size: 1.5em; margin: 0; line-height: 25px;">
                        <% if (noticia.link) { %>
                            <a href="<%= noticia.link %>" target="_blank" style="color: #000000; text-decoration: none;">
                                <%= noticia.titulo %>
                            </a>
                        <% } else { %>
                            <%= noticia.titulo %>
                        <% } %>
                    </p>
                </td>
            </tr>
        
            <tr>
                <td style="padding-left: 5%; padding-right: 0%; padding-top: 0px;">
                    <p style="color: #000000; white-space: normal; word-wrap: break-word; overflow: visible; max-height: none; line-height: 1.5em; height: auto;">
                        <%= noticia.resumen ? noticia.resumen.replace(/\n/g, '<br>') : 'No hay resumen disponible.' %> <!-- Muestra un mensaje por defecto si no hay resumen -->
                    </p>
                </td>
            </tr>
            
            <% if (index === 2) { %> <!-- La tercera noticia está en el índice 2 -->
                <tr>
                    <td align="center">
                        <p style="height: 0px; text-align: left; border-top: 1px solid #37c0df; width: 90%; padding: 0; margin: 0;">&nbsp;</p>
                    </td>
                </tr>
            
                <tr>
                    <td colspan="3" style="padding-left: 5%; padding-right: 0%; padding-top: 0px;">
                        <p style="margin: 0;font-weight: 700; color: #36c0df; background: #000; padding: 10px; width: 20%; text-align: center;">
                            <a href="https://eleconomista.com.mx/el-empresario/gestion" style="color: #36c0df; text-decoration: none;" target="_blank" zcurl_name="l_7">GESTIÓN</a>
                        </p>
                    </td>
                </tr>
            <% } %>
        <% }); %>
        

       

        <tr>
            <td align="center" style="background-color: #36BFDF;">
                <a href="https://www.eleconomista.com.mx/el-empresario">
                    <img src="https://media.eleconomista.com.mx/contenido/depurador/images/empresario/logoinferior.png" style="width: 70%; padding-bottom: 20px; padding-top: 20px;" alt="El Empresario">
                </a>
            </td>
        </tr>



        <tr align="center" style="background-color: #36BFDF;">
			
			<td align="center" style= "margin: 0; padding: 0; width: 130px; display: flex;    padding-bottom: 2em;">
				
				
				<p style="display: contents; vertical-align: top; font-weight: bold;">Siguenos:</p>
				
				<a href="https://www.twitter.com/elempresariomx" target="_blank" style="text-decoration: none;">
					<img src="https://media.eleconomista.com.mx/contenido/depurador/images/empresario/twiter.png" width="35" height="35" border="0" alt="Twitter" style="
					margin-right: 10px;     vertical-align: middle;     margin-top: -5px;
    margin-left: 10px;"/>
				</a>

				<a href="http://www.facebook.com/elempresariomx" target="_blank" style="text-decoration: none;">
					<img src="https://media.eleconomista.com.mx/contenido/depurador/images/empresario/face.png" width="35" height="35" border="0" alt="Facebook" style="
					margin-right: 10px;     vertical-align: middle;  margin-top: -5px;"/>
				</a>
				
				
				
				
			</td>

			<tr style="background-color: #36BFDF; text-align: right; margin: 0; padding-bottom: 10px;">
				<td style="padding-bottom: 10px;  padding-right: 2em;">
					<img src="https://media.eleconomista.com.mx/contenido/depurador/images/empresario/url.png" style="width: 1.5%; padding-bottom: 0px; padding-top: 0px;"><a href="https://www.eleconomista.com.mx/el-empresario" style="     color: #000;
					text-decoration: none;"> eleconomista.com.mx/el-empresario</a>
				</td>
			</tr>
			
		</tr>


		<tr style="background-color: #fff;">
			<td>
				<p style="text-align: center; font-size: 0.8em; padding: 10px 30px 0px;">Acerca de este boletín electrónico, este boletín es un beneficio para suscriptores del servicio de noticias de El Empresario
					ANÚNCIATE CON NOSOTROS I AVISO DE PRIVACIDAD</p>
			</td>
		</tr>
		
		<tr style="background-color: #fff;">
			<td>
				<p style="text-align: center; font-size: 0.6em; padding: 00px;">El Economista Av. San Jerónimo 458, Jardines del Pedregal, Alvaro Obregón 01900, CDMX</p>
			</td>
		</tr>

          <!-- El botón de descarga (será eliminado antes de la descarga) -->
        <tr>
            <td align="center">
                <button id="downloadBtn" onclick="downloadBoletin()">Descargar boletín</button>
            </td>
        </tr>

        <!-- Formulario para ingresar las URLs -->
<tr>
    <td align="center" style="background-color: #36BFDF;">
<form id="urlForm" onsubmit="actualizarURLs(event)">
    <label for="url1">URL 1 (Nota principal):</label>
    <input type="url" id="url1" name="url1" required><br><br>

    <label for="url2">URL 2 (PYMES):</label>
    <input type="url" id="url2" name="url2" required><br><br>

    <label for="url3">URL 3 (PYMES):</label>
    <input type="url" id="url3" name="url3" required><br><br>

    <label for="url4">URL 4 (PYMES):</label>
    <input type="url" id="url4" name="url4" required><br><br>

    <label for="url5">URL 5 (GESTION):</label>
    <input type="url" id="url5" name="url5" required><br><br>

    <label for="url6">URL 6 (GESTION):</label>
    <input type="url" id="url6" name="url6" required><br><br>

    <label for="url7">URL 7 (GESTION):</label>
    <input type="url" id="url7" name="url7" required><br><br>

    <button type="submit">Actualizar URLs</button>
</form>
    </td>
</tr>

          
    </table>

    <script>
        function obtenerProximoJueves() {
            var hoy = new Date();
            var diasSemana = hoy.getDay(); // 0 es domingo, 1 es lunes, ..., 6 es sábado

            // Calculamos cuántos días faltan para el próximo jueves (día 4)
            var diasParaJueves = (4 - diasSemana + 7) % 7;
           /*diasParaJueves = diasParaJueves === 0 ? 7 : diasParaJueves; // Si es jueves hoy, muestra el próximo jueves*/

            // Calculamos la fecha del próximo jueves
            hoy.setDate(hoy.getDate() + diasParaJueves);
            
            // Creamos la fecha en el formato deseado (día de la semana, día del mes de año)
            var opciones = { year: 'numeric', month: 'long', day: 'numeric' };
            var fechaProximoJueves = hoy.toLocaleDateString('es-ES', opciones);
            
            // Colocamos la fecha en el lugar adecuado
            document.getElementById('fecha-del-boletin').textContent = fechaProximoJueves;
        }

        // Llamamos a la función cuando cargue la página
        window.onload = obtenerProximoJueves;

        // Manejar el formulario para enviar las URLs al servidor
    const form = document.getElementById('urlForm');
    form.addEventListener('submit', function(event) {
        event.preventDefault();

        const urls = [];
        // Capturar las URLs ingresadas en los campos del formulario
        for (let i = 1; i <= 7; i++) {
            const url = document.getElementById('url' + i).value;
            if (isValidUrl(url)) {
                urls.push(url);
            } else {
                alert('La URL ' + i + ' no es válida');
                return;
            }
        }

        // Enviar las URLs al backend
        fetch('/api/guardar-urls', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ urls })
        })
        .then(response => response.json())
        .then(data => {
            alert('URLs actualizadas correctamente');
            console.log(data.message);
        })
        .catch(error => {
            console.error('Error al actualizar las URLs:', error);
            alert('Error al actualizar las URLs');
        });
    });

    // Función para validar si la URL es válida
    function isValidUrl(url) {
        const regex = /^(https?|ftp):\/\/[^\s/$.?#].[^\s]*$/i;
        return regex.test(url);
    }

      // Función para actualizar las URLs y recargar la página
      function actualizarURLs(event) {
        event.preventDefault();  // Evitar que el formulario se envíe de forma predeterminada

        // Luego de que se actualicen las URLs, recargamos la página
        location.reload();  // Recarga la página

        // Desplazar la ventana hacia arriba
        window.scrollTo(0, 0);  // Asegura que la página se desplace hacia la parte superior
    }

    function downloadBoletin() {
    // Eliminar el formulario y el botón de descarga del contenido
    var formulario = document.getElementById('urlForm');
    var downloadBtn = document.getElementById('downloadBtn');
    
    // Eliminar los elementos antes de generar el archivo HTML
    if (formulario) {
        formulario.parentNode.removeChild(formulario);
    }
    if (downloadBtn) {
        downloadBtn.parentNode.removeChild(downloadBtn);
    }

    // Crear el contenido del boletín (sin el formulario y sin el botón de descarga)
    var htmlContent = ` 
        <!DOCTYPE html>
        <html lang="es">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width initial-scale=1">
            <meta name="viewport" content="width=device-width" />
            <title><%= noticias.length > 0 ? noticias[0].titulo : 'Boletín' %></title>
            <style>
                #templateContainer {
                    width: 650px;
                    font-family: 'Helvetica Neue', Arial, Helvetica, 'sans-serif';
                }
                @media only screen and (max-width: 550px) {
                    table[id=templateContainer] {
                        width: 100% !important;
                    }
                    table[class=columns] {
                        width: 100% !important;
                    }
                }
            </style>
        </head>
        <body leftmargin="0" topmargin="0" bgcolor="#fafafa" marginwidth="0" marginheight="0">
            ${document.body.innerHTML}
        </body>
        </html>
    `;

    // Crear un Blob del contenido HTML
    var blob = new Blob([htmlContent], { type: 'text/html' });
    var url = URL.createObjectURL(blob);

    // Crear un enlace para la descarga
    var a = document.createElement('a');
    a.href = url;
    a.download = 'boletin.html'; // El nombre del archivo
    a.click();


    // Después de la descarga, restauramos la visibilidad del formulario y el botón
    setTimeout(function() {
        formulario.style.display = 'block';  // Restaurar el formulario
        downloadBtn.style.display = 'block'; // Restaurar el botón de descarga
    
     // Recargar la página
     location.reload();  // Recarga la página después de 100 ms
    }, 100); // Restaurar después de 100 ms
}
    </script>

</body>
</html>
